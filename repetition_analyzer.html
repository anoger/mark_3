<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de R√©p√©titions - Th√®se IHM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- PDF.js library for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
/* ============================================================================
   VARIABLES CSS
   ============================================================================ */
:root {
    /* Couleurs de base */
    --ink: #1a1a1a;
    --ink-light: #4a4a4a;
    --paper: #f8f5f0;
    --cream: #faf8f5;
    --cream-dark: #f0ebe3;
    --accent: #8b4513;
    --accent-light: #a0522d;
    --accent-pale: rgba(139, 69, 19, 0.1);
    --border: #d4c4b0;
    --border-light: #e8dfd3;

    /* Statuts de r√©p√©tition */
    --rep-unnecessary: #c62828;
    --rep-unnecessary-bg: rgba(198, 40, 40, 0.1);
    --rep-reformulate: #f57c00;
    --rep-reformulate-bg: rgba(245, 124, 0, 0.1);
    --rep-justified: #2e7d32;
    --rep-justified-bg: rgba(46, 125, 50, 0.1);
    --rep-pending: #78909c;
    --rep-pending-bg: rgba(120, 144, 156, 0.1);

    /* Types de r√©p√©tition */
    --type-ngram: #1565c0;
    --type-concept: #7b1fa2;
    --type-citation: #00796b;
    --type-definition: #e65100;
    --type-paraphrase: #558b2f;

    /* Canvas */
    --canvas-bg: #e8e4df;
    --grid-line: rgba(139, 69, 19, 0.08);
    --node-shadow: 0 4px 12px rgba(0,0,0,0.12);
    --node-shadow-hover: 0 8px 24px rgba(0,0,0,0.18);

    /* Couleurs chapitres */
    --ch1: #e57373;
    --ch2: #64b5f6;
    --ch3: #81c784;
    --ch4: #ffb74d;
    --ch5: #ba68c8;
    --ch6: #4db6ac;
    --ch7: #a1887f;

    /* Typographie */
    --font-serif: 'Cormorant Garamond', Georgia, serif;
    --font-sans: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

    /* Dimensions */
    --header-height: 60px;
    --sidebar-width: 320px;

    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
}

/* ============================================================================
   RESET & BASE
   ============================================================================ */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
    overflow: hidden;
}

body {
    font-family: var(--font-sans);
    font-size: 14px;
    color: var(--ink);
    background: var(--paper);
    line-height: 1.5;
}

/* ============================================================================
   HEADER / TOOLBAR
   ============================================================================ */
#header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--cream);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.5rem;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.toolbar-left {
    display: flex;
    align-items: baseline;
    gap: 1rem;
}

.tool-title {
    font-family: var(--font-serif);
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--accent);
    margin: 0;
}

.subtitle {
    font-size: 0.85rem;
    color: var(--ink-light);
}

.toolbar-center {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.toolbar-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Groupes de boutons */
.btn-group {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    background: var(--paper);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.25rem;
}

.btn-group button {
    padding: 0.4rem 0.75rem;
    border: none;
    background: transparent;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-family: var(--font-sans);
    color: var(--ink-light);
    transition: all var(--transition-fast);
}

.btn-group button:hover {
    background: var(--cream-dark);
    color: var(--ink);
}

.btn-group button.active {
    background: var(--accent);
    color: white;
}

.btn-group #zoom-level {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    min-width: 50px;
    text-align: center;
    color: var(--ink-light);
}

/* Boutons principaux */
.btn-primary, .btn-secondary {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-family: var(--font-sans);
    font-weight: 500;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover {
    background: var(--accent-light);
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--paper);
    color: var(--ink);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background: var(--cream-dark);
    border-color: var(--accent);
}

/* ============================================================================
   CANVAS VIEWPORT
   ============================================================================ */
#canvas-viewport {
    position: fixed;
    top: var(--header-height);
    left: 0;
    right: var(--sidebar-width);
    bottom: 0;
    overflow: hidden;
    background: var(--canvas-bg);
    cursor: grab;
}

#canvas-viewport:active {
    cursor: grabbing;
}

#canvas-world {
    position: absolute;
    transform-origin: 0 0;
    width: 10000px;
    height: 10000px;
    background-image:
        linear-gradient(var(--grid-line) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
    background-size: 50px 50px;
}

/* Noeuds de r√©p√©tition */
.repetition-node {
    position: absolute;
    background: var(--cream);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    min-width: 280px;
    max-width: 380px;
    box-shadow: var(--node-shadow);
    cursor: move;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast);
    user-select: none;
}

.repetition-node:hover {
    box-shadow: var(--node-shadow-hover);
    transform: translateY(-2px);
}

.repetition-node.selected {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-pale), var(--node-shadow-hover);
}

.repetition-node[data-status="unnecessary"] { border-color: var(--rep-unnecessary); background: var(--rep-unnecessary-bg); }
.repetition-node[data-status="reformulate"] { border-color: var(--rep-reformulate); background: var(--rep-reformulate-bg); }
.repetition-node[data-status="justified"] { border-color: var(--rep-justified); background: var(--rep-justified-bg); }
.repetition-node[data-status="pending"] { border-color: var(--rep-pending); }

.node-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.node-type {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    color: white;
}

.node-type.type-ngram { background: var(--type-ngram); }
.node-type.type-concept { background: var(--type-concept); }
.node-type.type-citation { background: var(--type-citation); }
.node-type.type-definition { background: var(--type-definition); }
.node-type.type-paraphrase { background: var(--type-paraphrase); }

.node-status {
    font-size: 1.2rem;
}

.node-content {
    margin-bottom: 0.75rem;
}

.node-text {
    font-family: var(--font-serif);
    font-size: 0.95rem;
    color: var(--ink);
    line-height: 1.5;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.node-locations {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
}

.location-tag {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    background: var(--paper);
    border: 1px solid var(--border-light);
    color: var(--ink-light);
}

.location-tag[data-chapter="ch1"] { border-color: var(--ch1); color: var(--ch1); }
.location-tag[data-chapter="ch2"] { border-color: var(--ch2); color: var(--ch2); }
.location-tag[data-chapter="ch3"] { border-color: var(--ch3); color: var(--ch3); }
.location-tag[data-chapter="ch4"] { border-color: var(--ch4); color: var(--ch4); }
.location-tag[data-chapter="ch5"] { border-color: var(--ch5); color: var(--ch5); }
.location-tag[data-chapter="ch6"] { border-color: var(--ch6); color: var(--ch6); }
.location-tag[data-chapter="ch7"] { border-color: var(--ch7); color: var(--ch7); }

.node-actions {
    display: flex;
    gap: 0.5rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-light);
}

.btn-action {
    flex: 1;
    padding: 0.4rem;
    border: 1px solid var(--border);
    background: var(--paper);
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: all var(--transition-fast);
}

.btn-action:hover {
    transform: scale(1.05);
}

.btn-action.btn-unnecessary:hover { background: var(--rep-unnecessary); color: white; border-color: var(--rep-unnecessary); }
.btn-action.btn-reformulate:hover { background: var(--rep-reformulate); color: white; border-color: var(--rep-reformulate); }
.btn-action.btn-justified:hover { background: var(--rep-justified); color: white; border-color: var(--rep-justified); }

/* Liens entre noeuds */
.node-link {
    position: absolute;
    pointer-events: none;
    z-index: -1;
}

.node-link line {
    stroke: var(--border);
    stroke-width: 2;
    stroke-dasharray: 5, 5;
}

/* ============================================================================
   SIDEBAR
   ============================================================================ */
#sidebar {
    position: fixed;
    top: var(--header-height);
    right: 0;
    width: var(--sidebar-width);
    bottom: 0;
    background: var(--cream);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.sidebar-section {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-light);
}

.sidebar-section h3 {
    font-family: var(--font-serif);
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sidebar-section h3 span {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    font-weight: 400;
    color: var(--ink-light);
}

/* Stats */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.stat-item {
    background: var(--paper);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
}

.stat-value {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--accent);
    display: block;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--ink-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Scores */
.score-bar {
    display: grid;
    grid-template-columns: 80px 1fr 40px;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.score-label {
    font-size: 0.8rem;
    color: var(--ink-light);
}

.progress-bar {
    height: 8px;
    background: var(--paper);
    border: 1px solid var(--border-light);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    border-radius: 4px;
    transition: width var(--transition-normal);
    width: 0%;
}

.score-value {
    font-family: var(--font-mono);
    font-size: 0.85rem;
    color: var(--ink);
    text-align: right;
}

/* Filtres */
.filter-group {
    margin-bottom: 0.75rem;
}

.filter-group label {
    display: block;
    font-size: 0.75rem;
    color: var(--ink-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.35rem;
}

.filter-group select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--paper);
    font-family: var(--font-sans);
    font-size: 0.85rem;
    color: var(--ink);
    cursor: pointer;
    transition: border-color var(--transition-fast);
}

.filter-group select:hover {
    border-color: var(--accent);
}

.filter-group select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-pale);
}

/* Liste r√©p√©titions */
.sidebar-list {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#repetition-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.list-item {
    padding: 0.75rem;
    background: var(--paper);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.list-item:hover {
    border-color: var(--accent);
    transform: translateX(2px);
}

.list-item.selected {
    border-color: var(--accent);
    background: var(--accent-pale);
}

.list-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.35rem;
}

.list-item-type {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    padding: 0.15rem 0.35rem;
    border-radius: 3px;
    color: white;
}

.list-item-status {
    font-size: 0.9rem;
}

.list-item-text {
    font-family: var(--font-serif);
    font-size: 0.85rem;
    color: var(--ink);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* ============================================================================
   MODAL
   ============================================================================ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--cream);
    border-radius: 16px;
    width: 90%;
    max-width: 700px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalIn 0.25s ease;
}

@keyframes modalIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border);
}

.modal-header h2 {
    font-family: var(--font-serif);
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--accent);
    margin: 0;
}

.modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--paper);
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--ink-light);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.modal-close:hover {
    background: var(--rep-unnecessary);
    color: white;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.detail-section {
    margin-bottom: 1.25rem;
}

.detail-section h4 {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--ink-light);
    margin-bottom: 0.5rem;
}

.detail-section .badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
}

.text-block {
    font-family: var(--font-serif);
    font-size: 1.05rem;
    line-height: 1.7;
    color: var(--ink);
    background: var(--paper);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.occurrence-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.occurrence-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: var(--paper);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.85rem;
}

.occurrence-chapter {
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
}

.occurrence-file {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--ink-light);
}

.auto-eval {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    padding: 0.75rem;
    background: var(--paper);
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.eval-status {
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.eval-confidence {
    font-family: var(--font-mono);
    font-size: 0.8rem;
    color: var(--ink-light);
}

.eval-reason {
    font-size: 0.85rem;
    color: var(--ink);
    flex-basis: 100%;
}

.annotation-form {
    background: var(--paper);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.status-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.btn-status {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid var(--border);
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    font-family: var(--font-sans);
    transition: all var(--transition-fast);
}

.btn-status:hover {
    transform: translateY(-2px);
}

.btn-status.btn-unnecessary:hover,
.btn-status.btn-unnecessary.active {
    background: var(--rep-unnecessary);
    border-color: var(--rep-unnecessary);
    color: white;
}

.btn-status.btn-reformulate:hover,
.btn-status.btn-reformulate.active {
    background: var(--rep-reformulate);
    border-color: var(--rep-reformulate);
    color: white;
}

.btn-status.btn-justified:hover,
.btn-status.btn-justified.active {
    background: var(--rep-justified);
    border-color: var(--rep-justified);
    color: white;
}

.annotation-form textarea {
    width: 100%;
    min-height: 80px;
    padding: 0.75rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-family: var(--font-sans);
    font-size: 0.9rem;
    resize: vertical;
    transition: border-color var(--transition-fast);
}

.annotation-form textarea:focus {
    outline: none;
    border-color: var(--accent);
}

.modal-footer {
    display: flex;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    background: var(--paper);
    border-radius: 0 0 16px 16px;
}

/* ============================================================================
   VISUALIZATIONS
   ============================================================================ */

/* Heatmap */
.heatmap-container {
    position: absolute;
    background: var(--cream);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--node-shadow);
}

.heatmap-title {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 1rem;
    text-align: center;
}

.heatmap-grid {
    display: grid;
    gap: 3px;
}

.heatmap-header {
    display: contents;
}

.heatmap-header span {
    font-size: 0.7rem;
    font-weight: 600;
    text-align: center;
    padding: 0.25rem;
    color: var(--ink-light);
}

.heatmap-row {
    display: contents;
}

.heatmap-label {
    font-size: 0.7rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 0.5rem;
    color: var(--ink-light);
}

.heatmap-cell {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: transform var(--transition-fast);
}

.heatmap-cell:hover {
    transform: scale(1.1);
    z-index: 1;
}

/* Network graph */
.network-container {
    position: absolute;
}

.network-node {
    position: absolute;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: var(--node-shadow);
    transition: transform var(--transition-fast);
    border: 3px solid white;
}

.network-node:hover {
    transform: scale(1.1);
}

.network-node-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.network-node-count {
    font-family: var(--font-mono);
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
}

.network-link {
    position: absolute;
    pointer-events: none;
}

/* Timeline */
.timeline-container {
    position: absolute;
    background: var(--cream);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--node-shadow);
    min-width: 600px;
}

.timeline-title {
    font-family: var(--font-serif);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 1rem;
}

.timeline-track {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
}

.timeline-label {
    width: 100px;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--ink-light);
    text-align: right;
    padding-right: 1rem;
    flex-shrink: 0;
}

.timeline-bar {
    flex: 1;
    height: 24px;
    background: var(--paper);
    border: 1px solid var(--border-light);
    border-radius: 4px;
    position: relative;
}

.timeline-marker {
    position: absolute;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    cursor: pointer;
    transition: transform var(--transition-fast);
}

.timeline-marker:hover {
    transform: translate(-50%, -50%) scale(1.5);
}

.timeline-marker.type-ngram { background: var(--type-ngram); }
.timeline-marker.type-concept { background: var(--type-concept); }
.timeline-marker.type-citation { background: var(--type-citation); }
.timeline-marker.type-definition { background: var(--type-definition); }
.timeline-marker.type-paraphrase { background: var(--type-paraphrase); }

/* ============================================================================
   LOADING MODAL
   ============================================================================ */
#loading-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(248, 245, 240, 0.95);
    z-index: 3000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#loading-modal.active {
    display: flex;
}

.loading-content {
    text-align: center;
}

.loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1.5rem;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    font-family: var(--font-serif);
    font-size: 1.2rem;
    color: var(--accent);
    margin-bottom: 0.5rem;
}

.loading-subtext {
    font-size: 0.9rem;
    color: var(--ink-light);
}

/* ============================================================================
   EMPTY STATE
   ============================================================================ */
.empty-state {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    padding: 3rem;
    max-width: 500px;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state-title {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 0.75rem;
}

.empty-state-text {
    font-size: 0.95rem;
    color: var(--ink-light);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

/* ============================================================================
   TOOLTIPS
   ============================================================================ */
[data-tooltip] {
    position: relative;
}

[data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    padding: 0.4rem 0.75rem;
    background: var(--ink);
    color: white;
    font-size: 0.75rem;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-fast);
    margin-bottom: 0.5rem;
}

[data-tooltip]:hover::after {
    opacity: 1;
}

/* ============================================================================
   SCROLLBAR
   ============================================================================ */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--cream-dark);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
}

/* ============================================================================
   FILE INPUT MODAL
   ============================================================================ */
#file-modal .modal-content {
    max-width: 600px;
}

.file-drop-zone {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 3rem 2rem;
    text-align: center;
    margin-bottom: 1rem;
    transition: all var(--transition-fast);
    cursor: pointer;
}

.file-drop-zone:hover,
.file-drop-zone.drag-over {
    border-color: var(--accent);
    background: var(--accent-pale);
}

.file-drop-zone-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.6;
}

.file-drop-zone-text {
    font-size: 1rem;
    color: var(--ink);
    margin-bottom: 0.5rem;
}

.file-drop-zone-hint {
    font-size: 0.85rem;
    color: var(--ink-light);
}

.file-list {
    max-height: 200px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: var(--paper);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    margin-bottom: 0.35rem;
    font-size: 0.85rem;
}

.file-item-name {
    font-family: var(--font-mono);
    color: var(--ink);
}

.file-item-size {
    color: var(--ink-light);
    font-size: 0.75rem;
}

.file-item-remove {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--rep-unnecessary);
    font-size: 1.1rem;
    padding: 0.25rem;
    transition: transform var(--transition-fast);
}

.file-item-remove:hover {
    transform: scale(1.2);
}

/* Alternative: textarea input */
.textarea-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    color: var(--ink-light);
    font-size: 0.85rem;
}

.textarea-input {
    width: 100%;
    min-height: 150px;
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    resize: vertical;
    display: none;
}

.textarea-input.active {
    display: block;
}

/* ============================================================================
   EXPORT MODAL
   ============================================================================ */
.export-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.export-option {
    padding: 1.5rem;
    background: var(--paper);
    border: 2px solid var(--border);
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.export-option:hover {
    border-color: var(--accent);
    transform: translateY(-3px);
    box-shadow: var(--node-shadow);
}

.export-option-icon {
    font-size: 2rem;
    margin-bottom: 0.75rem;
}

.export-option-title {
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 0.35rem;
}

.export-option-desc {
    font-size: 0.8rem;
    color: var(--ink-light);
}
    </style>
</head>
<body>
    <!-- Header / Toolbar -->
    <header id="header">
        <div class="toolbar-left">
            <h1 class="tool-title">Analyseur de R√©p√©titions</h1>
            <span class="subtitle">Th√®se IHM - Chantier 7.4</span>
        </div>

        <div class="toolbar-center">
            <!-- Contr√¥les zoom -->
            <div class="btn-group">
                <button id="btn-zoom-out" data-tooltip="Zoom arri√®re">‚àí</button>
                <span id="zoom-level">100%</span>
                <button id="btn-zoom-in" data-tooltip="Zoom avant">+</button>
                <button id="btn-fit" data-tooltip="Ajuster √† l'√©cran">‚ä°</button>
            </div>

            <!-- Layout -->
            <div class="btn-group">
                <button id="btn-layout-grid" class="active" data-tooltip="Disposition grille">‚ñ¶</button>
                <button id="btn-layout-force" data-tooltip="Disposition force">‚óâ</button>
                <button id="btn-layout-chapter" data-tooltip="Grouper par chapitre">‚ò∞</button>
            </div>

            <!-- Vues -->
            <div class="btn-group">
                <button id="btn-view-nodes" class="active">Noeuds</button>
                <button id="btn-view-heatmap">Heatmap</button>
                <button id="btn-view-network">R√©seau</button>
                <button id="btn-view-timeline">Timeline</button>
            </div>
        </div>

        <div class="toolbar-right">
            <button id="btn-load" class="btn-primary">üìÅ Charger fichiers</button>
            <button id="btn-analyze" class="btn-primary" disabled>üîç Analyser</button>
            <button id="btn-export" class="btn-secondary" disabled>üì• Exporter</button>
        </div>
    </header>

    <!-- Canvas Viewport -->
    <div id="canvas-viewport">
        <div id="canvas-world">
            <!-- Empty state -->
            <div class="empty-state" id="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <h2 class="empty-state-title">Aucun fichier charg√©</h2>
                <p class="empty-state-text">
                    Cliquez sur <strong>Charger fichiers</strong> pour importer vos fichiers LaTeX (.tex) ou PDF (.pdf)
                    et lancer l'analyse des r√©p√©titions dans votre manuscrit de th√®se.
                </p>
                <button class="btn-primary" onclick="App.showFileModal()">üìÅ Charger fichiers</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar">
        <!-- Stats -->
        <section class="sidebar-section">
            <h3>Statistiques</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="stat-total">0</span>
                    <span class="stat-label">R√©p√©titions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stat-pending">0</span>
                    <span class="stat-label">√Ä √©valuer</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stat-files">0</span>
                    <span class="stat-label">Fichiers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="stat-words">0</span>
                    <span class="stat-label">Mots</span>
                </div>
            </div>
        </section>

        <!-- Scores -->
        <section class="sidebar-section">
            <h3>Scores d'√©valuation</h3>
            <div class="score-bar">
                <span class="score-label">Coh√©rence</span>
                <div class="progress-bar"><div id="score-coherence" class="progress-fill"></div></div>
                <span class="score-value" id="score-coherence-val">--</span>
            </div>
            <div class="score-bar">
                <span class="score-label">Pertinence</span>
                <div class="progress-bar"><div id="score-pertinence" class="progress-fill"></div></div>
                <span class="score-value" id="score-pertinence-val">--</span>
            </div>
            <div class="score-bar">
                <span class="score-label">Profondeur</span>
                <div class="progress-bar"><div id="score-depth" class="progress-fill"></div></div>
                <span class="score-value" id="score-depth-val">--</span>
            </div>
        </section>

        <!-- Filtres -->
        <section class="sidebar-section">
            <h3>Filtres</h3>
            <div class="filter-group">
                <label>Type</label>
                <select id="filter-type">
                    <option value="all">Tous les types</option>
                    <option value="ngram">N-grammes</option>
                    <option value="concept">Concepts</option>
                    <option value="citation">Citations</option>
                    <option value="definition">D√©finitions</option>
                    <option value="paraphrase">Paraphrases</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Statut</label>
                <select id="filter-status">
                    <option value="all">Tous les statuts</option>
                    <option value="pending">Non √©valu√©</option>
                    <option value="unnecessary">√Ä supprimer</option>
                    <option value="reformulate">√Ä reformuler</option>
                    <option value="justified">Justifi√©</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Chapitre</label>
                <select id="filter-chapter">
                    <option value="all">Tous les chapitres</option>
                    <option value="ch1">Ch.1 Introduction</option>
                    <option value="ch2">Ch.2 √âtat de l'Art</option>
                    <option value="ch3">Ch.3 M√©thodologie</option>
                    <option value="ch4">Ch.4 √âtude 1</option>
                    <option value="ch5">Ch.5 √âtude 2</option>
                    <option value="ch6">Ch.6 Discussion</option>
                    <option value="ch7">Ch.7 Conclusion</option>
                </select>
            </div>
        </section>

        <!-- Liste -->
        <section class="sidebar-section sidebar-list">
            <h3>R√©p√©titions <span id="list-count">(0)</span></h3>
            <div id="repetition-list">
                <!-- Dynamically populated -->
            </div>
        </section>
    </aside>

    <!-- File Modal -->
    <div id="file-modal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Charger des fichiers</h2>
                <button class="modal-close" onclick="App.hideFileModal()">√ó</button>
            </header>
            <div class="modal-body">
                <div class="file-drop-zone" id="file-drop-zone">
                    <div class="file-drop-zone-icon">üìÑ</div>
                    <div class="file-drop-zone-text">Glissez vos fichiers .tex ou .pdf ici</div>
                    <div class="file-drop-zone-hint">ou cliquez pour parcourir</div>
                    <input type="file" id="file-input" multiple accept=".tex,.pdf" style="display: none;">
                </div>
                <div class="file-format-info" id="pdf-info" style="display:none; margin-bottom: 1rem; padding: 0.75rem; background: var(--accent-pale); border-radius: 8px; font-size: 0.85rem;">
                    <strong>üìã PDF d√©tect√© :</strong> L'extraction du texte peut prendre quelques secondes. Les fichiers PDF compil√©s depuis LaTeX donnent les meilleurs r√©sultats.
                </div>
                <div class="file-list" id="file-list"></div>

                <div class="textarea-toggle">
                    <span>ou</span>
                    <button class="btn-secondary" onclick="App.toggleTextarea()">Coller du texte</button>
                </div>
                <textarea id="textarea-input" class="textarea-input" placeholder="Collez le contenu LaTeX ici..."></textarea>
            </div>
            <footer class="modal-footer">
                <button class="btn-secondary" onclick="App.hideFileModal()">Annuler</button>
                <button class="btn-primary" id="btn-confirm-files" onclick="App.confirmFiles()">Confirmer</button>
            </footer>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2>D√©tail de la r√©p√©tition</h2>
                <button class="modal-close" onclick="App.hideDetailModal()">√ó</button>
            </header>
            <div class="modal-body">
                <div class="detail-section">
                    <h4>Type</h4>
                    <span id="detail-type" class="badge"></span>
                </div>

                <div class="detail-section">
                    <h4>Texte</h4>
                    <div id="detail-text" class="text-block"></div>
                </div>

                <div class="detail-section">
                    <h4>Occurrences</h4>
                    <div id="detail-occurrences" class="occurrence-list"></div>
                </div>

                <div class="detail-section">
                    <h4>√âvaluation automatique</h4>
                    <div id="detail-auto-eval" class="auto-eval"></div>
                </div>

                <div class="detail-section">
                    <h4>Annotation manuelle</h4>
                    <div class="annotation-form">
                        <div class="status-buttons">
                            <button class="btn-status btn-unnecessary" data-status="unnecessary" onclick="App.setStatus('unnecessary')">
                                ‚úó √Ä supprimer
                            </button>
                            <button class="btn-status btn-reformulate" data-status="reformulate" onclick="App.setStatus('reformulate')">
                                ‚Üª √Ä reformuler
                            </button>
                            <button class="btn-status btn-justified" data-status="justified" onclick="App.setStatus('justified')">
                                ‚úì Justifi√©e
                            </button>
                        </div>
                        <textarea id="annotation-comment" placeholder="Commentaire (optionnel)..."></textarea>
                    </div>
                </div>
            </div>
            <footer class="modal-footer">
                <button class="btn-secondary" onclick="App.prevRepetition()">‚Üê Pr√©c√©dent</button>
                <button class="btn-primary" onclick="App.saveAnnotation()">Enregistrer</button>
                <button class="btn-secondary" onclick="App.nextRepetition()">Suivant ‚Üí</button>
            </footer>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <header class="modal-header">
                <h2>Exporter les r√©sultats</h2>
                <button class="modal-close" onclick="App.hideExportModal()">√ó</button>
            </header>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-option" onclick="App.exportJSON()">
                        <div class="export-option-icon">üìã</div>
                        <div class="export-option-title">JSON</div>
                        <div class="export-option-desc">Structure compl√®te pour archivage</div>
                    </div>
                    <div class="export-option" onclick="App.exportCSV()">
                        <div class="export-option-icon">üìä</div>
                        <div class="export-option-title">CSV</div>
                        <div class="export-option-desc">Import Excel / Sheets</div>
                    </div>
                    <div class="export-option" onclick="App.exportLaTeX()">
                        <div class="export-option-icon">üìù</div>
                        <div class="export-option-title">LaTeX</div>
                        <div class="export-option-desc">Commentaires √† ins√©rer</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Analyse en cours...</div>
            <div class="loading-subtext" id="loading-subtext">Veuillez patienter</div>
        </div>
    </div>

    <script>
/* ============================================================================
   MAIN APPLICATION
   ============================================================================ */
const App = {
    // =========================================================================
    // STATE
    // =========================================================================
    state: {
        files: new Map(),           // filename -> content
        repetitions: [],            // detected repetitions
        annotations: new Map(),     // id -> annotation
        canvas: { x: 0, y: 0, scale: 1 },
        selectedId: null,
        currentView: 'nodes',
        currentLayout: 'grid',
        filters: { type: 'all', status: 'all', chapter: 'all' },
        isDragging: false,
        dragStart: { x: 0, y: 0 },
        pendingFiles: []
    },

    // =========================================================================
    // CONFIGURATION
    // =========================================================================
    config: {
        ngramMinLength: 4,
        ngramMaxLength: 12,
        minOccurrences: 2,
        similarityThreshold: 0.7,
        // Termes cl√©s de la th√®se
        conceptKeywords: [
            // Th√©ories motivationnelles
            'motivation intrins√®que', 'motivation extrins√®que', 'autod√©termination',
            'SDT', 'CET', 'th√©orie de l\'autod√©termination', 'th√©orie de l\'√©valuation cognitive',
            // Int√©r√™t
            'int√©r√™t situationnel', 'int√©r√™t individuel', 'int√©r√™t d√©clench√©', 'int√©r√™t maintenu',
            // ICAP
            'ICAP', 'Interactive Constructive Active Passive', 'engagement cognitif',
            // CASA et agence sociale
            'CASA', 'Computers Are Social Actors', 'agence sociale', 'pr√©sence sociale',
            'paradigme CASA', 'ethopoeia',
            // Illusion de compr√©hension
            'illusion de compr√©hension', 'IOED', 'illusion of explanatory depth',
            'heuristique de fluidit√©', 'fluidit√©', 'fluency',
            // Agents
            'agent p√©dagogique', 'agent conversationnel', 'agent virtuel',
            'anthropomorphisme', 'incarnation', 'embodiment',
            // Questions de recherche
            'QR1', 'QR2', 'QR3', 'question de recherche',
            'H1', 'H2', 'H3a', 'H3b', 'hypoth√®se',
            // Autres concepts cl√©s
            'uncanny valley', 'vall√©e de l\'√©trange',
            'affiliation', 'autonomie', 'comp√©tence',
            'feedback', 'charge cognitive', 'CTML'
        ]
    },

    // =========================================================================
    // INITIALIZATION
    // =========================================================================
    init() {
        this.setupCanvas();
        this.setupEventListeners();
        this.loadAnnotations();
        this.updateUI();
    },

    setupCanvas() {
        const viewport = document.getElementById('canvas-viewport');
        const world = document.getElementById('canvas-world');

        // Pan
        viewport.addEventListener('mousedown', (e) => {
            if (e.target === viewport || e.target === world || e.target.classList.contains('empty-state')) {
                this.state.isDragging = true;
                this.state.dragStart = { x: e.clientX - this.state.canvas.x, y: e.clientY - this.state.canvas.y };
                viewport.style.cursor = 'grabbing';
            }
        });

        viewport.addEventListener('mousemove', (e) => {
            if (this.state.isDragging) {
                this.state.canvas.x = e.clientX - this.state.dragStart.x;
                this.state.canvas.y = e.clientY - this.state.dragStart.y;
                this.applyCanvasTransform();
            }
        });

        viewport.addEventListener('mouseup', () => {
            this.state.isDragging = false;
            viewport.style.cursor = 'grab';
        });

        viewport.addEventListener('mouseleave', () => {
            this.state.isDragging = false;
            viewport.style.cursor = 'grab';
        });

        // Zoom
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.min(3, Math.max(0.2, this.state.canvas.scale * delta));

            const rect = viewport.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            this.state.canvas.x = mouseX - (mouseX - this.state.canvas.x) * (newScale / this.state.canvas.scale);
            this.state.canvas.y = mouseY - (mouseY - this.state.canvas.y) * (newScale / this.state.canvas.scale);
            this.state.canvas.scale = newScale;

            this.applyCanvasTransform();
            document.getElementById('zoom-level').textContent = Math.round(newScale * 100) + '%';
        });
    },

    applyCanvasTransform() {
        const world = document.getElementById('canvas-world');
        world.style.transform = `translate(${this.state.canvas.x}px, ${this.state.canvas.y}px) scale(${this.state.canvas.scale})`;
    },

    setupEventListeners() {
        // Toolbar buttons
        document.getElementById('btn-zoom-in').addEventListener('click', () => this.zoom(1.2));
        document.getElementById('btn-zoom-out').addEventListener('click', () => this.zoom(0.8));
        document.getElementById('btn-fit').addEventListener('click', () => this.fitToScreen());

        document.getElementById('btn-layout-grid').addEventListener('click', () => this.setLayout('grid'));
        document.getElementById('btn-layout-force').addEventListener('click', () => this.setLayout('force'));
        document.getElementById('btn-layout-chapter').addEventListener('click', () => this.setLayout('chapter'));

        document.getElementById('btn-view-nodes').addEventListener('click', () => this.setView('nodes'));
        document.getElementById('btn-view-heatmap').addEventListener('click', () => this.setView('heatmap'));
        document.getElementById('btn-view-network').addEventListener('click', () => this.setView('network'));
        document.getElementById('btn-view-timeline').addEventListener('click', () => this.setView('timeline'));

        document.getElementById('btn-load').addEventListener('click', () => this.showFileModal());
        document.getElementById('btn-analyze').addEventListener('click', () => this.analyze());
        document.getElementById('btn-export').addEventListener('click', () => this.showExportModal());

        // File input
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('file-drop-zone');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            this.handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));

        // Filters
        document.getElementById('filter-type').addEventListener('change', (e) => {
            this.state.filters.type = e.target.value;
            this.applyFilters();
        });
        document.getElementById('filter-status').addEventListener('change', (e) => {
            this.state.filters.status = e.target.value;
            this.applyFilters();
        });
        document.getElementById('filter-chapter').addEventListener('change', (e) => {
            this.state.filters.chapter = e.target.value;
            this.applyFilters();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.hideAllModals();
            }
        });
    },

    // =========================================================================
    // FILE HANDLING
    // =========================================================================
    showFileModal() {
        document.getElementById('file-modal').classList.add('active');
    },

    hideFileModal() {
        document.getElementById('file-modal').classList.remove('active');
    },

    toggleTextarea() {
        const textarea = document.getElementById('textarea-input');
        textarea.classList.toggle('active');
    },

    handleFiles(fileList) {
        const files = Array.from(fileList).filter(f =>
            f.name.endsWith('.tex') || f.name.endsWith('.pdf')
        );
        this.state.pendingFiles = [...this.state.pendingFiles, ...files];
        this.updateFileList();

        // Show PDF info if any PDF files
        const hasPdf = this.state.pendingFiles.some(f => f.name.endsWith('.pdf'));
        document.getElementById('pdf-info').style.display = hasPdf ? 'block' : 'none';
    },

    updateFileList() {
        const listEl = document.getElementById('file-list');
        listEl.innerHTML = this.state.pendingFiles.map((f, i) => `
            <div class="file-item">
                <span class="file-item-name">
                    ${f.name.endsWith('.pdf') ? 'üìï' : 'üìÑ'} ${f.name}
                </span>
                <span class="file-item-size">${(f.size / 1024).toFixed(1)} KB</span>
                <button class="file-item-remove" onclick="App.removeFile(${i})">√ó</button>
            </div>
        `).join('');
    },

    removeFile(index) {
        this.state.pendingFiles.splice(index, 1);
        this.updateFileList();
    },

    async confirmFiles() {
        const textarea = document.getElementById('textarea-input');
        const hasPdf = this.state.pendingFiles.some(f => f.name.endsWith('.pdf'));

        if (hasPdf) {
            this.showLoading('Chargement des fichiers...', 'Extraction du texte PDF en cours');
        }

        // Load from files
        for (const file of this.state.pendingFiles) {
            const chapter = this.detectChapter(file.name);

            if (file.name.endsWith('.pdf')) {
                // Extract text from PDF
                this.updateLoading(`Extraction de ${file.name}...`);
                try {
                    const content = await PDFParser.extractText(file);
                    // Re-detect chapter using content if filename didn't work
                    const detectedChapter = chapter === 'unknown' ?
                        this.detectChapter(file.name, content) : chapter;
                    this.state.files.set(file.name, {
                        content,
                        chapter: detectedChapter,
                        name: file.name,
                        type: 'pdf'
                    });
                } catch (err) {
                    console.error('PDF extraction error:', err);
                    alert(`Erreur lors de l'extraction du PDF "${file.name}": ${err.message}`);
                }
            } else {
                // Regular text file
                const content = await file.text();
                this.state.files.set(file.name, {
                    content,
                    chapter,
                    name: file.name,
                    type: 'tex'
                });
            }
        }

        // Load from textarea
        if (textarea.value.trim()) {
            this.state.files.set('pasted_content.tex', {
                content: textarea.value,
                chapter: 'unknown',
                name: 'pasted_content.tex',
                type: 'tex'
            });
        }

        this.state.pendingFiles = [];
        textarea.value = '';
        this.hideFileModal();
        if (hasPdf) this.hideLoading();

        document.getElementById('btn-analyze').disabled = this.state.files.size === 0;
        document.getElementById('stat-files').textContent = this.state.files.size;

        // Count words
        let totalWords = 0;
        this.state.files.forEach(f => {
            const cleanFn = f.type === 'pdf' ? PDFParser.cleanContent : LaTeXParser.cleanContent;
            totalWords += cleanFn(f.content).split(/\s+/).length;
        });
        document.getElementById('stat-words').textContent = totalWords > 1000 ?
            (totalWords / 1000).toFixed(1) + 'k' : totalWords;

        if (this.state.files.size > 0) {
            document.getElementById('empty-state').style.display = 'none';
        }

        // Hide PDF info
        document.getElementById('pdf-info').style.display = 'none';
    },

    detectChapter(filename, content = null) {
        // First try filename-based detection
        if (/ch1|introduction/i.test(filename)) return 'ch1';
        if (/ch2|etat|art/i.test(filename)) return 'ch2';
        if (/ch3|methodo/i.test(filename)) return 'ch3';
        if (/ch4|exp.*1/i.test(filename)) return 'ch4';
        if (/ch5|exp.*2/i.test(filename)) return 'ch5';
        if (/ch6|discussion/i.test(filename)) return 'ch6';
        if (/ch7|conclusion/i.test(filename)) return 'ch7';
        // Section detection for ch2
        if (/2_1/i.test(filename)) return 'ch2';
        if (/2_2/i.test(filename)) return 'ch2';
        if (/2_3/i.test(filename)) return 'ch2';
        if (/2_4/i.test(filename)) return 'ch2';
        if (/2_5/i.test(filename)) return 'ch2';
        if (/2_6/i.test(filename)) return 'ch2';

        // For PDFs with generic names, try content-based detection
        if (content && filename.endsWith('.pdf')) {
            return PDFParser.detectChapterFromContent(content);
        }

        return 'unknown';
    },

    // =========================================================================
    // ANALYSIS
    // =========================================================================
    async analyze() {
        this.showLoading('Analyse en cours...', 'Parsing des fichiers');

        await this.sleep(100); // Allow UI to update

        // Parse files
        const parsed = new Map();
        this.state.files.forEach((file, name) => {
            const isPdf = file.type === 'pdf';
            parsed.set(name, {
                ...file,
                clean: isPdf ? PDFParser.cleanContent(file.content) : LaTeXParser.cleanContent(file.content),
                citations: isPdf ? PDFParser.extractCitations(file.content) : LaTeXParser.extractCitations(file.content),
                sections: isPdf ? PDFParser.extractSections(file.content) : LaTeXParser.extractSections(file.content)
            });
        });

        this.updateLoading('D√©tection des n-grammes...');
        await this.sleep(50);

        // Detect repetitions
        const repetitions = [];
        let idCounter = 1;

        // 1. N-grams
        const ngrams = RepetitionDetector.detectNgrams(parsed, this.config.ngramMinLength, this.config.ngramMaxLength);
        ngrams.forEach((locations, text) => {
            if (locations.length >= this.config.minOccurrences) {
                repetitions.push({
                    id: idCounter++,
                    type: 'ngram',
                    text: text,
                    locations: locations,
                    status: 'pending'
                });
            }
        });

        this.updateLoading('D√©tection des concepts cl√©s...');
        await this.sleep(50);

        // 2. Concepts
        const concepts = RepetitionDetector.detectConcepts(parsed, this.config.conceptKeywords);
        concepts.forEach((locations, concept) => {
            const chapters = new Set(locations.map(l => l.chapter));
            if (chapters.size > 1 || locations.length >= 3) {
                repetitions.push({
                    id: idCounter++,
                    type: 'concept',
                    text: concept,
                    locations: locations,
                    status: 'pending'
                });
            }
        });

        this.updateLoading('D√©tection des citations crois√©es...');
        await this.sleep(50);

        // 3. Citations
        const citations = RepetitionDetector.detectCitationRepetitions(parsed);
        citations.forEach((locations, cite) => {
            const chapters = new Set(locations.map(l => l.chapter));
            if (chapters.size > 1) {
                repetitions.push({
                    id: idCounter++,
                    type: 'citation',
                    text: `\\cite{${cite}}`,
                    locations: locations,
                    status: 'pending'
                });
            }
        });

        this.updateLoading('√âvaluation automatique...');
        await this.sleep(50);

        // Auto-evaluate
        repetitions.forEach(rep => {
            const autoEval = RepetitionEvaluator.autoEvaluate(rep);
            rep.autoEval = autoEval;
            // Apply auto status if high confidence
            if (autoEval.confidence >= 0.7) {
                rep.status = autoEval.status;
            }
        });

        this.state.repetitions = repetitions;

        // Calculate scores
        const scores = RepetitionEvaluator.calculateScores(repetitions);
        this.updateScores(scores);

        this.hideLoading();
        this.renderRepetitions();
        document.getElementById('btn-export').disabled = false;
    },

    // =========================================================================
    // RENDERING
    // =========================================================================
    renderRepetitions() {
        const world = document.getElementById('canvas-world');

        // Clear existing nodes (keep grid)
        world.querySelectorAll('.repetition-node, .heatmap-container, .network-container, .timeline-container').forEach(el => el.remove());
        document.getElementById('empty-state').style.display = 'none';

        const filtered = this.getFilteredRepetitions();

        switch (this.state.currentView) {
            case 'nodes':
                this.renderNodes(filtered);
                break;
            case 'heatmap':
                this.renderHeatmap();
                break;
            case 'network':
                this.renderNetwork();
                break;
            case 'timeline':
                this.renderTimeline(filtered);
                break;
        }

        this.renderList(filtered);
        this.updateStats();
    },

    renderNodes(repetitions) {
        const world = document.getElementById('canvas-world');

        repetitions.forEach((rep, index) => {
            const node = this.createNode(rep);

            // Position based on layout
            const pos = this.calculatePosition(index, repetitions.length, rep);
            node.style.left = pos.x + 'px';
            node.style.top = pos.y + 'px';

            world.appendChild(node);
        });
    },

    createNode(rep) {
        const node = document.createElement('div');
        node.className = 'repetition-node';
        node.dataset.id = rep.id;
        node.dataset.status = rep.status;

        const typeLabels = {
            ngram: 'N-gramme',
            concept: 'Concept',
            citation: 'Citation',
            definition: 'D√©finition',
            paraphrase: 'Paraphrase'
        };

        const statusIcons = {
            pending: '‚è≥',
            unnecessary: '‚úó',
            reformulate: '‚Üª',
            justified: '‚úì'
        };

        node.innerHTML = `
            <div class="node-header">
                <span class="node-type type-${rep.type}">${typeLabels[rep.type] || rep.type}</span>
                <span class="node-status">${statusIcons[rep.status]}</span>
            </div>
            <div class="node-content">
                <div class="node-text">"${this.truncate(rep.text, 100)}"</div>
                <div class="node-locations">
                    ${rep.locations.slice(0, 4).map(loc => `
                        <span class="location-tag" data-chapter="${loc.chapter}">${this.chapterLabel(loc.chapter)}</span>
                    `).join('')}
                    ${rep.locations.length > 4 ? `<span class="location-tag">+${rep.locations.length - 4}</span>` : ''}
                </div>
            </div>
            <div class="node-actions">
                <button class="btn-action btn-unnecessary" title="√Ä supprimer">‚úó</button>
                <button class="btn-action btn-reformulate" title="√Ä reformuler">‚Üª</button>
                <button class="btn-action btn-justified" title="Justifi√©e">‚úì</button>
            </div>
        `;

        // Events
        node.addEventListener('click', (e) => {
            if (!e.target.classList.contains('btn-action')) {
                this.selectRepetition(rep.id);
            }
        });

        node.addEventListener('dblclick', () => this.showDetailModal(rep.id));

        node.querySelectorAll('.btn-action').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const status = btn.classList.contains('btn-unnecessary') ? 'unnecessary' :
                              btn.classList.contains('btn-reformulate') ? 'reformulate' : 'justified';
                this.setRepetitionStatus(rep.id, status);
            });
        });

        // Make draggable
        this.makeDraggable(node);

        return node;
    },

    makeDraggable(node) {
        let isDragging = false;
        let startX, startY, origX, origY;

        node.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('btn-action')) return;
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            origX = parseInt(node.style.left) || 0;
            origY = parseInt(node.style.top) || 0;
            node.style.zIndex = 100;
            e.stopPropagation();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = (e.clientX - startX) / this.state.canvas.scale;
            const dy = (e.clientY - startY) / this.state.canvas.scale;
            node.style.left = (origX + dx) + 'px';
            node.style.top = (origY + dy) + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                node.style.zIndex = '';
            }
        });
    },

    calculatePosition(index, total, rep) {
        const margin = 50;
        const nodeWidth = 320;
        const nodeHeight = 180;

        switch (this.state.currentLayout) {
            case 'grid': {
                const cols = Math.ceil(Math.sqrt(total));
                const col = index % cols;
                const row = Math.floor(index / cols);
                return {
                    x: margin + col * (nodeWidth + 30),
                    y: margin + row * (nodeHeight + 30)
                };
            }
            case 'force': {
                // Simple force-directed approximation
                const angle = (index / total) * Math.PI * 2;
                const radius = 200 + Math.sqrt(total) * 50;
                return {
                    x: 500 + Math.cos(angle) * radius * (1 + Math.random() * 0.3),
                    y: 400 + Math.sin(angle) * radius * (1 + Math.random() * 0.3)
                };
            }
            case 'chapter': {
                const chapterOffsets = {
                    ch1: { x: 50, y: 50 },
                    ch2: { x: 400, y: 50 },
                    ch3: { x: 750, y: 50 },
                    ch4: { x: 50, y: 400 },
                    ch5: { x: 400, y: 400 },
                    ch6: { x: 750, y: 400 },
                    ch7: { x: 400, y: 750 },
                    unknown: { x: 750, y: 750 }
                };
                const mainChapter = rep.locations[0]?.chapter || 'unknown';
                const offset = chapterOffsets[mainChapter] || chapterOffsets.unknown;
                const localIndex = this.state.repetitions
                    .filter(r => (r.locations[0]?.chapter || 'unknown') === mainChapter)
                    .indexOf(rep);
                return {
                    x: offset.x + (localIndex % 3) * 200,
                    y: offset.y + Math.floor(localIndex / 3) * 150
                };
            }
            default:
                return { x: margin + index * 50, y: margin + index * 30 };
        }
    },

    renderHeatmap() {
        const world = document.getElementById('canvas-world');
        const container = document.createElement('div');
        container.className = 'heatmap-container';
        container.style.left = '100px';
        container.style.top = '100px';

        const chapters = ['ch1', 'ch2', 'ch3', 'ch4', 'ch5', 'ch6', 'ch7'];
        const matrix = this.buildMatrix(chapters);
        const maxVal = Math.max(...matrix.flat(), 1);

        let html = '<div class="heatmap-title">Matrice des r√©p√©titions inter-chapitres</div>';
        html += '<div class="heatmap-grid" style="grid-template-columns: 60px repeat(7, 40px);">';

        // Header
        html += '<div class="heatmap-header"><span></span>';
        chapters.forEach(ch => {
            html += `<span>${this.chapterLabel(ch)}</span>`;
        });
        html += '</div>';

        // Rows
        chapters.forEach((ch1, i) => {
            html += '<div class="heatmap-row">';
            html += `<span class="heatmap-label">${this.chapterLabel(ch1)}</span>`;
            chapters.forEach((ch2, j) => {
                const val = matrix[i][j];
                const intensity = val / maxVal;
                const color = this.getHeatColor(intensity);
                html += `<div class="heatmap-cell" style="background:${color}" title="${this.chapterLabel(ch1)} ‚Üî ${this.chapterLabel(ch2)}: ${val}">${val || ''}</div>`;
            });
            html += '</div>';
        });

        html += '</div>';
        container.innerHTML = html;
        world.appendChild(container);
    },

    buildMatrix(chapters) {
        const matrix = chapters.map(() => chapters.map(() => 0));

        this.state.repetitions.forEach(rep => {
            const repChapters = [...new Set(rep.locations.map(l => l.chapter))];
            for (let i = 0; i < repChapters.length; i++) {
                for (let j = i; j < repChapters.length; j++) {
                    const idx1 = chapters.indexOf(repChapters[i]);
                    const idx2 = chapters.indexOf(repChapters[j]);
                    if (idx1 >= 0 && idx2 >= 0) {
                        matrix[idx1][idx2]++;
                        if (idx1 !== idx2) matrix[idx2][idx1]++;
                    }
                }
            }
        });

        return matrix;
    },

    getHeatColor(intensity) {
        if (intensity === 0) return 'var(--paper)';
        // From light yellow to dark red
        const r = Math.round(255);
        const g = Math.round(255 - intensity * 180);
        const b = Math.round(200 - intensity * 200);
        return `rgb(${r},${g},${b})`;
    },

    renderNetwork() {
        const world = document.getElementById('canvas-world');
        const container = document.createElement('div');
        container.className = 'network-container';

        const chapters = ['ch1', 'ch2', 'ch3', 'ch4', 'ch5', 'ch6', 'ch7'];
        const chapterCounts = {};
        chapters.forEach(ch => chapterCounts[ch] = 0);

        this.state.repetitions.forEach(rep => {
            rep.locations.forEach(loc => {
                if (chapterCounts[loc.chapter] !== undefined) {
                    chapterCounts[loc.chapter]++;
                }
            });
        });

        const colors = {
            ch1: 'var(--ch1)', ch2: 'var(--ch2)', ch3: 'var(--ch3)',
            ch4: 'var(--ch4)', ch5: 'var(--ch5)', ch6: 'var(--ch6)', ch7: 'var(--ch7)'
        };

        // Draw links first
        const matrix = this.buildMatrix(chapters);
        const centerX = 450, centerY = 350, radius = 200;

        let linksHtml = '<svg class="network-link" style="position:absolute;left:0;top:0;width:1000px;height:800px;pointer-events:none;">';
        chapters.forEach((ch1, i) => {
            const angle1 = (i / chapters.length) * Math.PI * 2 - Math.PI / 2;
            const x1 = centerX + Math.cos(angle1) * radius;
            const y1 = centerY + Math.sin(angle1) * radius;

            chapters.forEach((ch2, j) => {
                if (j > i && matrix[i][j] > 0) {
                    const angle2 = (j / chapters.length) * Math.PI * 2 - Math.PI / 2;
                    const x2 = centerX + Math.cos(angle2) * radius;
                    const y2 = centerY + Math.sin(angle2) * radius;
                    const thickness = Math.min(8, 1 + matrix[i][j] / 2);
                    linksHtml += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="var(--border)" stroke-width="${thickness}" opacity="0.5"/>`;
                }
            });
        });
        linksHtml += '</svg>';
        container.innerHTML = linksHtml;

        // Draw nodes
        chapters.forEach((ch, i) => {
            const angle = (i / chapters.length) * Math.PI * 2 - Math.PI / 2;
            const x = centerX + Math.cos(angle) * radius - 40;
            const y = centerY + Math.sin(angle) * radius - 40;

            const node = document.createElement('div');
            node.className = 'network-node';
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            node.style.background = colors[ch];
            node.innerHTML = `
                <span class="network-node-label">${this.chapterLabel(ch)}</span>
                <span class="network-node-count">${chapterCounts[ch]}</span>
            `;
            container.appendChild(node);
        });

        world.appendChild(container);
    },

    renderTimeline(repetitions) {
        const world = document.getElementById('canvas-world');
        const container = document.createElement('div');
        container.className = 'timeline-container';
        container.style.left = '50px';
        container.style.top = '50px';

        let html = '<div class="timeline-title">Timeline des r√©p√©titions par fichier</div>';

        // Group by file
        const byFile = new Map();
        repetitions.forEach(rep => {
            rep.locations.forEach(loc => {
                if (!byFile.has(loc.file)) byFile.set(loc.file, []);
                byFile.get(loc.file).push({ ...rep, position: loc.position || 0 });
            });
        });

        byFile.forEach((reps, file) => {
            const shortName = file.split('/').pop().replace(/\.(tex|pdf)$/, '');
            html += `
                <div class="timeline-track">
                    <div class="timeline-label">${this.truncate(shortName, 12)}</div>
                    <div class="timeline-bar">
                        ${reps.map(r => `
                            <div class="timeline-marker type-${r.type}"
                                 style="left:${Math.random() * 90 + 5}%"
                                 title="${this.truncate(r.text, 50)}"></div>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        world.appendChild(container);
    },

    renderList(repetitions) {
        const list = document.getElementById('repetition-list');
        const typeLabels = {
            ngram: 'N-gramme', concept: 'Concept', citation: 'Citation',
            definition: 'D√©finition', paraphrase: 'Paraphrase'
        };
        const statusIcons = {
            pending: '‚è≥', unnecessary: '‚úó', reformulate: '‚Üª', justified: '‚úì'
        };

        list.innerHTML = repetitions.map(rep => `
            <div class="list-item ${this.state.selectedId === rep.id ? 'selected' : ''}"
                 data-id="${rep.id}" onclick="App.selectRepetition(${rep.id})">
                <div class="list-item-header">
                    <span class="list-item-type type-${rep.type}">${typeLabels[rep.type]}</span>
                    <span class="list-item-status">${statusIcons[rep.status]}</span>
                </div>
                <div class="list-item-text">"${this.truncate(rep.text, 60)}"</div>
            </div>
        `).join('');

        document.getElementById('list-count').textContent = `(${repetitions.length})`;
    },

    // =========================================================================
    // UI HELPERS
    // =========================================================================
    updateStats() {
        document.getElementById('stat-total').textContent = this.state.repetitions.length;
        document.getElementById('stat-pending').textContent =
            this.state.repetitions.filter(r => r.status === 'pending').length;
    },

    updateScores(scores) {
        ['coherence', 'pertinence', 'depth'].forEach(key => {
            const val = Math.round(scores[key] || 0);
            document.getElementById(`score-${key}`).style.width = val + '%';
            document.getElementById(`score-${key}-val`).textContent = val;
        });
    },

    updateUI() {
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-view-${this.state.currentView}`)?.classList.add('active');
        document.getElementById(`btn-layout-${this.state.currentLayout}`)?.classList.add('active');
    },

    getFilteredRepetitions() {
        return this.state.repetitions.filter(rep => {
            if (this.state.filters.type !== 'all' && rep.type !== this.state.filters.type) return false;
            if (this.state.filters.status !== 'all' && rep.status !== this.state.filters.status) return false;
            if (this.state.filters.chapter !== 'all') {
                const hasChapter = rep.locations.some(l => l.chapter === this.state.filters.chapter);
                if (!hasChapter) return false;
            }
            return true;
        });
    },

    applyFilters() {
        this.renderRepetitions();
    },

    selectRepetition(id) {
        this.state.selectedId = id;

        // Update nodes
        document.querySelectorAll('.repetition-node').forEach(node => {
            node.classList.toggle('selected', parseInt(node.dataset.id) === id);
        });

        // Update list
        document.querySelectorAll('.list-item').forEach(item => {
            item.classList.toggle('selected', parseInt(item.dataset.id) === id);
        });
    },

    setRepetitionStatus(id, status) {
        const rep = this.state.repetitions.find(r => r.id === id);
        if (rep) {
            rep.status = status;
            this.state.annotations.set(id, { id, status, timestamp: Date.now() });
            this.saveAnnotations();
            this.renderRepetitions();

            // Recalculate scores
            const scores = RepetitionEvaluator.calculateScores(this.state.repetitions);
            this.updateScores(scores);
        }
    },

    // =========================================================================
    // MODALS
    // =========================================================================
    showDetailModal(id) {
        const rep = this.state.repetitions.find(r => r.id === id);
        if (!rep) return;

        this.state.selectedId = id;

        const typeLabels = {
            ngram: 'N-gramme', concept: 'Concept', citation: 'Citation',
            definition: 'D√©finition', paraphrase: 'Paraphrase'
        };

        document.getElementById('detail-type').textContent = typeLabels[rep.type];
        document.getElementById('detail-type').className = `badge type-${rep.type}`;
        document.getElementById('detail-text').textContent = rep.text;

        document.getElementById('detail-occurrences').innerHTML = rep.locations.map(loc => `
            <div class="occurrence-item">
                <span class="occurrence-chapter" style="background:var(--${loc.chapter})">${this.chapterLabel(loc.chapter)}</span>
                <span class="occurrence-file">${loc.file}</span>
            </div>
        `).join('');

        const autoEval = rep.autoEval || { status: 'pending', confidence: 0, reason: 'Non √©valu√©' };
        document.getElementById('detail-auto-eval').innerHTML = `
            <span class="eval-status" style="background:var(--rep-${autoEval.status}); color:white;">${autoEval.status}</span>
            <span class="eval-confidence">Confiance: ${Math.round(autoEval.confidence * 100)}%</span>
            <span class="eval-reason">${autoEval.reason}</span>
        `;

        // Update buttons
        document.querySelectorAll('.btn-status').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.status === rep.status);
        });

        document.getElementById('annotation-comment').value =
            this.state.annotations.get(id)?.comment || '';

        document.getElementById('detail-modal').classList.add('active');
    },

    hideDetailModal() {
        document.getElementById('detail-modal').classList.remove('active');
    },

    showExportModal() {
        document.getElementById('export-modal').classList.add('active');
    },

    hideExportModal() {
        document.getElementById('export-modal').classList.remove('active');
    },

    hideAllModals() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    },

    setStatus(status) {
        document.querySelectorAll('.btn-status').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.status === status);
        });
    },

    saveAnnotation() {
        const id = this.state.selectedId;
        const status = document.querySelector('.btn-status.active')?.dataset.status;
        const comment = document.getElementById('annotation-comment').value;

        if (id && status) {
            this.setRepetitionStatus(id, status);
            const ann = this.state.annotations.get(id) || { id };
            ann.comment = comment;
            this.state.annotations.set(id, ann);
            this.saveAnnotations();
        }

        this.hideDetailModal();
    },

    prevRepetition() {
        const filtered = this.getFilteredRepetitions();
        const idx = filtered.findIndex(r => r.id === this.state.selectedId);
        if (idx > 0) {
            this.showDetailModal(filtered[idx - 1].id);
        }
    },

    nextRepetition() {
        const filtered = this.getFilteredRepetitions();
        const idx = filtered.findIndex(r => r.id === this.state.selectedId);
        if (idx < filtered.length - 1) {
            this.showDetailModal(filtered[idx + 1].id);
        }
    },

    // =========================================================================
    // LAYOUT & VIEW
    // =========================================================================
    setLayout(layout) {
        this.state.currentLayout = layout;
        document.querySelectorAll('[id^="btn-layout-"]').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-layout-${layout}`).classList.add('active');
        if (this.state.repetitions.length > 0) {
            this.renderRepetitions();
        }
    },

    setView(view) {
        this.state.currentView = view;
        document.querySelectorAll('[id^="btn-view-"]').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-view-${view}`).classList.add('active');
        if (this.state.repetitions.length > 0) {
            this.renderRepetitions();
        }
    },

    zoom(factor) {
        this.state.canvas.scale = Math.min(3, Math.max(0.2, this.state.canvas.scale * factor));
        this.applyCanvasTransform();
        document.getElementById('zoom-level').textContent = Math.round(this.state.canvas.scale * 100) + '%';
    },

    fitToScreen() {
        this.state.canvas = { x: 50, y: 50, scale: 0.8 };
        this.applyCanvasTransform();
        document.getElementById('zoom-level').textContent = '80%';
    },

    // =========================================================================
    // EXPORT
    // =========================================================================
    exportJSON() {
        const data = {
            metadata: {
                date: new Date().toISOString(),
                tool: 'Thesis Repetition Analyzer',
                files: Array.from(this.state.files.keys())
            },
            summary: {
                total: this.state.repetitions.length,
                byType: this.groupBy(this.state.repetitions, 'type'),
                byStatus: this.groupBy(this.state.repetitions, 'status')
            },
            repetitions: this.state.repetitions,
            annotations: Array.from(this.state.annotations.values())
        };

        this.download('repetitions_analysis.json', JSON.stringify(data, null, 2), 'application/json');
        this.hideExportModal();
    },

    exportCSV() {
        const headers = ['ID', 'Type', 'Statut', 'Texte', 'Chapitres', 'Fichiers', 'Commentaire'];
        const rows = this.state.repetitions.map(rep => {
            const ann = this.state.annotations.get(rep.id);
            return [
                rep.id,
                rep.type,
                rep.status,
                `"${rep.text.replace(/"/g, '""')}"`,
                [...new Set(rep.locations.map(l => l.chapter))].join(';'),
                [...new Set(rep.locations.map(l => l.file))].join(';'),
                ann?.comment || ''
            ].join(',');
        });

        const csv = [headers.join(','), ...rows].join('\n');
        this.download('repetitions_analysis.csv', csv, 'text/csv;charset=utf-8');
        this.hideExportModal();
    },

    exportLaTeX() {
        let output = '% RAPPORT D\'ANALYSE DES R√âP√âTITIONS\n';
        output += `% G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}\n`;
        output += `% Total: ${this.state.repetitions.length} r√©p√©titions d√©tect√©es\n\n`;

        const byStatus = {
            unnecessary: this.state.repetitions.filter(r => r.status === 'unnecessary'),
            reformulate: this.state.repetitions.filter(r => r.status === 'reformulate'),
            justified: this.state.repetitions.filter(r => r.status === 'justified'),
            pending: this.state.repetitions.filter(r => r.status === 'pending')
        };

        output += '% === √Ä SUPPRIMER ===\n';
        byStatus.unnecessary.forEach(rep => {
            output += `% [SUPPRIMER] "${this.truncate(rep.text, 60)}"\n`;
            output += `%   Fichiers: ${rep.locations.map(l => l.file).join(', ')}\n`;
        });

        output += '\n% === √Ä REFORMULER ===\n';
        byStatus.reformulate.forEach(rep => {
            output += `% [REFORMULER] "${this.truncate(rep.text, 60)}"\n`;
            output += `%   Fichiers: ${rep.locations.map(l => l.file).join(', ')}\n`;
        });

        this.download('repetitions_annotations.tex', output, 'text/plain');
        this.hideExportModal();
    },

    download(filename, content, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    },

    // =========================================================================
    // PERSISTENCE
    // =========================================================================
    saveAnnotations() {
        localStorage.setItem('thesisRepetitionAnnotations',
            JSON.stringify(Array.from(this.state.annotations.entries())));
    },

    loadAnnotations() {
        try {
            const saved = localStorage.getItem('thesisRepetitionAnnotations');
            if (saved) {
                this.state.annotations = new Map(JSON.parse(saved));
            }
        } catch (e) {
            console.warn('Could not load annotations:', e);
        }
    },

    // =========================================================================
    // LOADING
    // =========================================================================
    showLoading(text, subtext) {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-subtext').textContent = subtext;
        document.getElementById('loading-modal').classList.add('active');
    },

    updateLoading(subtext) {
        document.getElementById('loading-subtext').textContent = subtext;
    },

    hideLoading() {
        document.getElementById('loading-modal').classList.remove('active');
    },

    // =========================================================================
    // UTILITIES
    // =========================================================================
    truncate(str, len) {
        return str.length > len ? str.substring(0, len) + '...' : str;
    },

    chapterLabel(ch) {
        const labels = {
            ch1: 'Ch.1', ch2: 'Ch.2', ch3: 'Ch.3', ch4: 'Ch.4',
            ch5: 'Ch.5', ch6: 'Ch.6', ch7: 'Ch.7', unknown: '?'
        };
        return labels[ch] || ch;
    },

    groupBy(arr, key) {
        return arr.reduce((acc, item) => {
            const k = item[key];
            acc[k] = (acc[k] || 0) + 1;
            return acc;
        }, {});
    },

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
};

/* ============================================================================
   LATEX PARSER
   ============================================================================ */
const LaTeXParser = {
    cleanContent(raw) {
        return raw
            // Remove comments
            .replace(/%.*$/gm, '')
            // Remove structure commands
            .replace(/\\(chapter|section|subsection|subsubsection)\*?\{[^}]*\}/g, ' ')
            // Remove labels and refs
            .replace(/\\(label|ref|pageref|autoref|nameref)\{[^}]*\}/g, '')
            // Remove figure/table environments
            .replace(/\\begin\{(figure|table)\}[\s\S]*?\\end\{\1\}/g, '')
            // Remove equation environments
            .replace(/\\begin\{(equation|align|eqnarray)\*?\}[\s\S]*?\\end\{\1\*?\}/g, '')
            // Convert formatting commands
            .replace(/\\(textbf|textit|emph|texttt|textsc)\{([^}]*)\}/g, '$2')
            // Handle French quotes
            .replace(/\\og\s*/g, '"').replace(/\\fg\s*(\{\})?/g, '"')
            // Remove other commands but keep content
            .replace(/\\[a-zA-Z]+(\[[^\]]*\])?\{([^}]*)\}/g, '$2')
            // Remove remaining commands
            .replace(/\\[a-zA-Z]+/g, '')
            // Clean up braces and special chars
            .replace(/[{}~]/g, ' ')
            // Normalize whitespace
            .replace(/\s+/g, ' ')
            .trim();
    },

    extractCitations(raw) {
        const citations = [];
        const regex = /\\cite[pt]?\{([^}]+)\}/g;
        let match;
        while ((match = regex.exec(raw)) !== null) {
            match[1].split(',').forEach(key => {
                citations.push(key.trim());
            });
        }
        return citations;
    },

    extractSections(raw) {
        const sections = [];
        const regex = /\\(chapter|section|subsection)\{([^}]+)\}/g;
        let match;
        while ((match = regex.exec(raw)) !== null) {
            sections.push({ type: match[1], title: match[2] });
        }
        return sections;
    }
};

/* ============================================================================
   PDF PARSER
   ============================================================================ */
const PDFParser = {
    // Initialize PDF.js worker
    init() {
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    },

    // Extract text from PDF file
    async extractText(file) {
        this.init();

        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let fullText = '';
        const numPages = pdf.numPages;

        for (let i = 1; i <= numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();

            // Extract text items and join them
            const pageText = textContent.items
                .map(item => item.str)
                .join(' ');

            fullText += pageText + '\n\n';
        }

        return fullText;
    },

    // Clean PDF content (similar to LaTeX but adapted for PDF output)
    cleanContent(raw) {
        return raw
            // Remove page numbers (standalone numbers on lines)
            .replace(/^\s*\d+\s*$/gm, '')
            // Remove common PDF artifacts
            .replace(/\f/g, ' ') // Form feed
            .replace(/\r/g, '') // Carriage returns
            // Remove URLs
            .replace(/https?:\/\/[^\s]+/g, '')
            // Remove email addresses
            .replace(/[\w.-]+@[\w.-]+\.\w+/g, '')
            // Clean up citation artifacts (e.g., "[12]", "(Smith, 2020)")
            .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
            // Remove figure/table references
            .replace(/(?:Figure|Fig\.|Table|Tab\.)\s*\d+(?:\.\d+)?/gi, '')
            // Normalize dashes and hyphens
            .replace(/[‚Äì‚Äî‚àí]/g, '-')
            // Remove multiple spaces
            .replace(/\s+/g, ' ')
            // Remove lines that are just numbers or very short
            .replace(/^\s*.{0,3}\s*$/gm, '')
            // Normalize whitespace
            .replace(/\n\s*\n/g, '\n')
            .trim();
    },

    // Extract citations from PDF text (pattern matching)
    extractCitations(raw) {
        const citations = [];

        // Pattern 1: Author (Year) or Author et al. (Year)
        const authorYearPattern = /([A-Z][a-z√Ä-√ø]+(?:\s+(?:et\s+al\.?|&|and)\s+[A-Z][a-z√Ä-√ø]+)?)\s*\((\d{4}[a-z]?)\)/g;
        let match;
        while ((match = authorYearPattern.exec(raw)) !== null) {
            const cite = `${match[1]}_${match[2]}`;
            if (!citations.includes(cite)) {
                citations.push(cite);
            }
        }

        // Pattern 2: (Author, Year) or (Author & Author, Year)
        const parenCitePattern = /\(([A-Z][a-z√Ä-√ø]+(?:\s*(?:&|et|and)\s*[A-Z][a-z√Ä-√ø]+)?(?:\s*et\s*al\.?)?),?\s*(\d{4}[a-z]?)\)/g;
        while ((match = parenCitePattern.exec(raw)) !== null) {
            const cite = `${match[1]}_${match[2]}`;
            if (!citations.includes(cite)) {
                citations.push(cite);
            }
        }

        // Pattern 3: Numeric citations [1], [1,2,3]
        const numericPattern = /\[(\d+(?:\s*,\s*\d+)*)\]/g;
        while ((match = numericPattern.exec(raw)) !== null) {
            match[1].split(',').forEach(num => {
                const cite = `ref_${num.trim()}`;
                if (!citations.includes(cite)) {
                    citations.push(cite);
                }
            });
        }

        return citations;
    },

    // Extract sections from PDF (based on formatting patterns)
    extractSections(raw) {
        const sections = [];

        // Pattern: Chapter/Section headers (numbered or not)
        const patterns = [
            // French: "Chapitre 1 : Titre" or "1. Titre"
            /^(?:Chapitre\s+)?(\d+(?:\.\d+)?)\s*[:.]\s*(.+)$/gm,
            // Section numbers: "2.1 Titre" or "2.1. Titre"
            /^(\d+\.\d+(?:\.\d+)?)\s*\.?\s+([A-Z√Ä-≈∏].{5,80})$/gm,
            // All caps headers
            /^([A-Z√Ä-≈∏][A-Z√Ä-≈∏\s]{10,60})$/gm
        ];

        patterns.forEach((pattern, idx) => {
            let match;
            while ((match = pattern.exec(raw)) !== null) {
                if (idx === 2) {
                    // All caps - likely a chapter/section title
                    sections.push({ type: 'section', title: match[1].trim() });
                } else {
                    sections.push({
                        type: match[1].includes('.') ? 'subsection' : 'chapter',
                        title: match[2].trim()
                    });
                }
            }
        });

        return sections;
    },

    // Detect chapter from PDF content
    detectChapterFromContent(text) {
        const lower = text.toLowerCase();
        const first2000 = lower.substring(0, 2000);

        if (/introduction\s+g[e√©]n[e√©]rale|chapitre\s*1/i.test(first2000)) return 'ch1';
        if (/[e√©]tat\s+de\s+l.art|revue\s+de\s+litt[e√©]rature|chapitre\s*2/i.test(first2000)) return 'ch2';
        if (/m[e√©]thodologie|chapitre\s*3/i.test(first2000)) return 'ch3';
        if (/exp[e√©]rimentation\s*1|[e√©]tude\s*1|chapitre\s*4/i.test(first2000)) return 'ch4';
        if (/exp[e√©]rimentation\s*2|[e√©]tude\s*2|chapitre\s*5/i.test(first2000)) return 'ch5';
        if (/discussion|chapitre\s*6/i.test(first2000)) return 'ch6';
        if (/conclusion|chapitre\s*7/i.test(first2000)) return 'ch7';

        return 'unknown';
    }
};

/* ============================================================================
   REPETITION DETECTOR
   ============================================================================ */
const RepetitionDetector = {
    detectNgrams(parsed, minN, maxN) {
        const ngrams = new Map();

        parsed.forEach((file, filename) => {
            const words = file.clean.toLowerCase()
                .replace(/[.,;:!?()¬´¬ª"'‚Äî‚Äì-]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 2);

            for (let n = minN; n <= maxN; n++) {
                for (let i = 0; i <= words.length - n; i++) {
                    const ngram = words.slice(i, i + n).join(' ');

                    // Skip if mostly stopwords
                    if (this.isStopwordHeavy(ngram)) continue;

                    if (!ngrams.has(ngram)) ngrams.set(ngram, []);
                    ngrams.get(ngram).push({
                        file: filename,
                        chapter: file.chapter,
                        position: i
                    });
                }
            }
        });

        // Filter: keep only repeated ngrams
        const filtered = new Map();
        ngrams.forEach((locs, text) => {
            // Check if appears in multiple locations or multiple times
            const uniqueFiles = new Set(locs.map(l => l.file));
            if (locs.length >= 2 && (uniqueFiles.size > 1 || locs.length >= 3)) {
                // Deduplicate by file
                const dedupedLocs = [];
                const seen = new Set();
                locs.forEach(loc => {
                    const key = `${loc.file}-${Math.floor(loc.position / 50)}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        dedupedLocs.push(loc);
                    }
                });
                if (dedupedLocs.length >= 2) {
                    filtered.set(text, dedupedLocs);
                }
            }
        });

        return filtered;
    },

    isStopwordHeavy(ngram) {
        const stopwords = new Set([
            'le', 'la', 'les', 'un', 'une', 'des', 'de', 'du', 'au', 'aux',
            'et', 'ou', 'mais', 'donc', 'car', 'ni', 'que', 'qui', 'quoi',
            'dans', 'sur', 'sous', 'avec', 'sans', 'pour', 'par', 'entre',
            'est', 'sont', '√™tre', 'avoir', 'fait', 'peut', 'cette', 'ces',
            'ce', 'cet', 'il', 'elle', 'ils', 'elles', 'nous', 'vous',
            'leur', 'leurs', 'son', 'sa', 'ses', 'mon', 'ma', 'mes',
            'plus', 'moins', 'tr√®s', 'bien', 'aussi', 'comme', 'm√™me'
        ]);
        const words = ngram.split(' ');
        const stopCount = words.filter(w => stopwords.has(w)).length;
        return stopCount / words.length > 0.6;
    },

    detectConcepts(parsed, keywords) {
        const concepts = new Map();

        keywords.forEach(keyword => {
            const regex = new RegExp(keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

            parsed.forEach((file, filename) => {
                const matches = file.clean.match(regex);
                if (matches && matches.length > 0) {
                    if (!concepts.has(keyword.toLowerCase())) {
                        concepts.set(keyword.toLowerCase(), []);
                    }
                    concepts.get(keyword.toLowerCase()).push({
                        file: filename,
                        chapter: file.chapter,
                        count: matches.length
                    });
                }
            });
        });

        return concepts;
    },

    detectCitationRepetitions(parsed) {
        const citations = new Map();

        parsed.forEach((file, filename) => {
            file.citations.forEach(cite => {
                if (!citations.has(cite)) citations.set(cite, []);
                citations.get(cite).push({
                    file: filename,
                    chapter: file.chapter
                });
            });
        });

        // Keep only citations appearing in multiple chapters
        const filtered = new Map();
        citations.forEach((locs, cite) => {
            const chapters = new Set(locs.map(l => l.chapter));
            if (chapters.size > 1) {
                filtered.set(cite, locs);
            }
        });

        return filtered;
    }
};

/* ============================================================================
   REPETITION EVALUATOR
   ============================================================================ */
const RepetitionEvaluator = {
    autoEvaluate(rep) {
        // Check for legitimate patterns
        const text = rep.text.toLowerCase();
        const chapters = [...new Set(rep.locations.map(l => l.chapter))];

        // QR/Hypotheses are legitimate repetitions
        if (/qr[123]|question de recherche|h[123]|hypoth√®se/i.test(text)) {
            const legitChapters = ['ch1', 'ch2', 'ch6', 'ch7'];
            if (chapters.every(ch => legitChapters.includes(ch))) {
                return { status: 'justified', confidence: 0.9, reason: 'Question de recherche/hypoth√®se (rappel structurel l√©gitime)' };
            }
        }

        // Key theoretical terms
        const theoryTerms = ['sdt', 'cet', 'icap', 'casa', 'ioed', 'ctml'];
        if (theoryTerms.some(t => text.includes(t))) {
            return { status: 'justified', confidence: 0.7, reason: 'Terme th√©orique cl√© (r√©p√©tition attendue)' };
        }

        // Citation in theory + discussion = legitimate
        if (rep.type === 'citation') {
            const hasTheory = chapters.includes('ch2');
            const hasDiscussion = chapters.some(ch => ['ch6', 'ch7'].includes(ch));
            if (hasTheory && hasDiscussion) {
                return { status: 'justified', confidence: 0.8, reason: 'Citation crois√©e th√©orie/discussion (l√©gitime)' };
            }
        }

        // Long n-gram in same chapter = suspicious
        if (rep.type === 'ngram' && rep.text.split(' ').length > 8) {
            const uniqueChapters = new Set(rep.locations.map(l => l.chapter));
            if (uniqueChapters.size === 1) {
                return { status: 'reformulate', confidence: 0.7, reason: 'Long passage r√©p√©t√© dans le m√™me chapitre' };
            }
            return { status: 'reformulate', confidence: 0.6, reason: 'Formulation identique longue √† reformuler' };
        }

        // Concept appearing many times
        if (rep.type === 'concept' && rep.locations.length > 5) {
            return { status: 'pending', confidence: 0.5, reason: 'Concept fr√©quent - v√©rifier si r√©p√©tition justifi√©e' };
        }

        return { status: 'pending', confidence: 0.3, reason: '√âvaluation manuelle recommand√©e' };
    },

    calculateScores(repetitions) {
        const total = repetitions.length || 1;
        const byStatus = {
            unnecessary: repetitions.filter(r => r.status === 'unnecessary').length,
            reformulate: repetitions.filter(r => r.status === 'reformulate').length,
            justified: repetitions.filter(r => r.status === 'justified').length,
            pending: repetitions.filter(r => r.status === 'pending').length
        };

        // Coherence: fewer unnecessary repetitions = better
        const coherence = 100 - (byStatus.unnecessary / total * 50) - (byStatus.reformulate / total * 25);

        // Pertinence: more justified = better
        const pertinence = 50 + (byStatus.justified / total * 50) - (byStatus.unnecessary / total * 30);

        // Depth: based on concept diversity
        const concepts = repetitions.filter(r => r.type === 'concept');
        const depth = concepts.length > 0 ?
            Math.min(100, 50 + concepts.length * 2) : 50;

        return {
            coherence: Math.max(0, Math.min(100, coherence)),
            pertinence: Math.max(0, Math.min(100, pertinence)),
            depth: Math.max(0, Math.min(100, depth))
        };
    }
};

/* ============================================================================
   INITIALIZATION
   ============================================================================ */
document.addEventListener('DOMContentLoaded', () => {
    App.init();
});
    </script>
</body>
</html>
